---
layout: post
titile: YYModel源码阅读
date: 2018-04-10 15:00:24.000000000 +09:00
---


#### YYClassInfo.h

##### 定义各类数据类型

    typedef NS_OPTIONS(NSUInteger, YYEncodingType) {
    YYEncodingTypeMask       = 0xFF, ///< mask of type value
    YYEncodingTypeUnknown    = 0, ///< unknown
    YYEncodingTypeVoid       = 1, ///< void
    YYEncodingTypeBool       = 2, ///< bool
    YYEncodingTypeInt8       = 3, ///< char / BOOL
    YYEncodingTypeUInt8      = 4, ///< unsigned char
    YYEncodingTypeInt16      = 5, ///< short
    YYEncodingTypeUInt16     = 6, ///< unsigned short
    YYEncodingTypeInt32      = 7, ///< int
    YYEncodingTypeUInt32     = 8, ///< unsigned int
    YYEncodingTypeInt64      = 9, ///< long long
    YYEncodingTypeUInt64     = 10, ///< unsigned long long
    YYEncodingTypeFloat      = 11, ///< float
    YYEncodingTypeDouble     = 12, ///< double
    YYEncodingTypeLongDouble = 13, ///< long double
    YYEncodingTypeObject     = 14, ///< id
    YYEncodingTypeClass      = 15, ///< Class
    YYEncodingTypeSEL        = 16, ///< SEL
    YYEncodingTypeBlock      = 17, ///< block
    YYEncodingTypePointer    = 18, ///< void*
    YYEncodingTypeStruct     = 19, ///< struct
    YYEncodingTypeUnion      = 20, ///< union
    YYEncodingTypeCString    = 21, ///< char*
    YYEncodingTypeCArray     = 22, ///< char[10] (for example)
    
    YYEncodingTypeQualifierMask   = 0xFF00,   ///< mask of qualifier
    YYEncodingTypeQualifierConst  = 1 << 8,  ///< const
    YYEncodingTypeQualifierIn     = 1 << 9,  ///< in
    YYEncodingTypeQualifierInout  = 1 << 10, ///< inout
    YYEncodingTypeQualifierOut    = 1 << 11, ///< out
    YYEncodingTypeQualifierBycopy = 1 << 12, ///< bycopy
    YYEncodingTypeQualifierByref  = 1 << 13, ///< byref
    YYEncodingTypeQualifierOneway = 1 << 14, ///< oneway
    
    YYEncodingTypePropertyMask         = 0xFF0000, ///< mask of property
    YYEncodingTypePropertyReadonly     = 1 << 16, ///< readonly
    YYEncodingTypePropertyCopy         = 1 << 17, ///< copy
    YYEncodingTypePropertyRetain       = 1 << 18, ///< retain
    YYEncodingTypePropertyNonatomic    = 1 << 19, ///< nonatomic
    YYEncodingTypePropertyWeak         = 1 << 20, ///< weak
    YYEncodingTypePropertyCustomGetter = 1 << 21, ///< getter=
    YYEncodingTypePropertyCustomSetter = 1 << 22, ///< setter=
    YYEncodingTypePropertyDynamic      = 1 << 23, ///< @dynamic
    };  
                       设置枚举类型值


##### 定义类实例变量模型信息
    /**
    Instance variable information.
    */
    @interface YYClassIvarInfo : NSObject
    @property (nonatomic, assign, readonly) Ivar ivar;              ///< ivar opaque struct 实例变量
    @property (nonatomic, strong, readonly) NSString *name;         ///< Ivar's name 实例变量名字
    @property (nonatomic, assign, readonly) ptrdiff_t offset;       ///< Ivar's offset 实例变量偏移量
    @property (nonatomic, strong, readonly) NSString *typeEncoding; ///< Ivar's type encoding 实例变量编码类型
    @property (nonatomic, assign, readonly) YYEncodingType type;    ///< Ivar's type

    /**
    Creates and returns an ivar info object.
 
    @param ivar ivar opaque struct
    @return A new object, or nil if an error occurs.
    */
    - (instancetype)initWithIvar:(Ivar)ivar; 初始化实例变量
    @end


##### 定义类的方法模型数据

    /**
    Method information.
    */
    @interface YYClassMethodInfo : NSObject
    @property (nonatomic, assign, readonly) Method method;                  ///< method opaque struct 类的方法
    @property (nonatomic, strong, readonly) NSString *name;                 ///< method name 方法名
    @property (nonatomic, assign, readonly) SEL sel;                        ///< method's selector 方法sel
    @property (nonatomic, assign, readonly) IMP imp;                        ///< method's 方法函数指针implementation
    @property (nonatomic, strong, readonly) NSString *typeEncoding;         ///< method's parameter 方法参数and return types
    @property (nonatomic, strong, readonly) NSString *returnTypeEncoding;   ///< return value's type 返回值类型
    @property (nullable, nonatomic, strong, readonly) NSArray<NSString *> *argumentTypeEncodings; ///< array of arguments' type 返回参数类型

    /**
    Creates and returns a method info object.
 
    @param method method opaque struct
    @return A new object, or nil if an error occurs.
    初始化类方法模型
    */
    - (instancetype)initWithMethod:(Method)method; 
    @end

##### 定义类的属性数据模型

    /**
    Property information.
    */
    @interface YYClassPropertyInfo : NSObject
    @property (nonatomic, assign, readonly) objc_property_t property; ///< property's opaque struct 属性结构
    @property (nonatomic, strong, readonly) NSString *name;           ///< property's name 属性名
    @property (nonatomic, assign, readonly) YYEncodingType type;      ///< property's type 属性类型
    @property (nonatomic, strong, readonly) NSString *typeEncoding;   ///< property's encoding value 属性编码类型
    @property (nonatomic, strong, readonly) NSString *ivarName;       ///< property's ivar name 属性中实例变量
    @property (nullable, nonatomic, assign, readonly) Class cls;      ///< may be nil 父类 可能为空
    @property (nullable, nonatomic, strong, readonly) NSArray<NSString *> *protocols; ///< may nil 协议
    @property (nonatomic, assign, readonly) SEL getter;               ///< getter (nonnull) get方法
    @property (nonatomic, assign, readonly) SEL setter;               ///< setter (nonnull) set方法

    /**
    Creates and returns a property info object.
 
    @param property property opaque struct
    @return A new object, or nil if an error occurs.
    初始化类的属性数据模型
    */
    - (instancetype)initWithProperty:(objc_property_t)property; 
    @end

##### 定义类信息数据模型
    /**
    Class information for a class.
    */
    @interface YYClassInfo : NSObject
    @property (nonatomic, assign, readonly) Class cls; ///< class object 类
    @property (nullable, nonatomic, assign, readonly) Class superCls; ///< super class object 父类
    @property (nullable, nonatomic, assign, readonly) Class metaCls;  ///< class's meta class object 元类
    @property (nonatomic, readonly) BOOL isMeta; ///< whether this class is meta class 是否有元类
    @property (nonatomic, strong, readonly) NSString *name; ///< class name 类名字
    @property (nullable, nonatomic, strong, readonly) YYClassInfo *superClassInfo; ///< super class's class info 当前类的父类信息
    @property (nullable, nonatomic, strong, readonly) NSDictionary<NSString *, YYClassIvarInfo *> *ivarInfos; ///< ivars 类的实例变量
    @property (nullable, nonatomic, strong, readonly) NSDictionary<NSString *, YYClassMethodInfo *> *methodInfos; ///< methods 类方法
    @property (nullable, nonatomic, strong, readonly) NSDictionary<NSString *, YYClassPropertyInfo *> *propertyInfos; ///< properties 类的属性

    /**
    If the class is changed (for example: you add a method to this class with
    'class_addMethod()'), you should call this method to refresh the class info cache.
    
    After called this method, `needUpdate` will returns `YES`, and you should call 
    'classInfoWithClass' or 'classInfoWithClassName' to get the updated class info.
    */
    - (void)setNeedUpdate;

    /**
    If this method returns `YES`, you should stop using this instance and call
    `classInfoWithClass` or `classInfoWithClassName` to get the updated class info.
    
    @return Whether this class info need update.
    */
    - (BOOL)needUpdate;

    /**
    Get the class info of a specified Class.
    
    @discussion This method will cache the class info and super-class info
    at the first access to the Class. This method is thread-safe.
    
    @param cls A class.
    @return A class info, or nil if an error occurs.
    */
    + (nullable instancetype)classInfoWithClass:(Class)cls;

    /**
    Get the class info of a specified Class.
    
    @discussion This method will cache the class info and super-class info
    at the first access to the Class. This method is thread-safe.
    
    @param className A class name.
    @return A class info, or nil if an error occurs.
    */
    + (nullable instancetype)classInfoWithClassName:(NSString *)className;

    @end

    NS_ASSUME_NONNULL_BEGIN
    NS_ASSUME_NONNULL_END     //在这两个宏之间的代码默认不能为空


#### YYCLassInfo.m

##### 定义C函数根据传入char返回YYEncodingType

    YYEncodingType YYEncodingGetType(const char *typeEncoding) {
        char *type = (char *)typeEncoding;
        if (!type) return YYEncodingTypeUnknown;
        size_t len = strlen(type);
        if (len == 0) return YYEncodingTypeUnknown;
        
        YYEncodingType qualifier = 0;
        bool prefix = true;
        while (prefix) {
            switch (*type) {
                case 'r': {
                    qualifier |= YYEncodingTypeQualifierConst;
                    type++;
                } break;
                case 'n': {
                    qualifier |= YYEncodingTypeQualifierIn;
                    type++;
                } break;
                case 'N': {
                    qualifier |= YYEncodingTypeQualifierInout;
                    type++;
                } break;
                case 'o': {
                    qualifier |= YYEncodingTypeQualifierOut;
                    type++;
                } break;
                case 'O': {
                    qualifier |= YYEncodingTypeQualifierBycopy;
                    type++;
                } break;
                case 'R': {
                    qualifier |= YYEncodingTypeQualifierByref;
                    type++;
                } break;
                case 'V': {
                    qualifier |= YYEncodingTypeQualifierOneway;
                    type++;
                } break;
                default: { prefix = false; } break;
            }
        }

        len = strlen(type);
        if (len == 0) return YYEncodingTypeUnknown | qualifier;

        switch (*type) {
            case 'v': return YYEncodingTypeVoid | qualifier;
            case 'B': return YYEncodingTypeBool | qualifier;
            case 'c': return YYEncodingTypeInt8 | qualifier;
            case 'C': return YYEncodingTypeUInt8 | qualifier;
            case 's': return YYEncodingTypeInt16 | qualifier;
            case 'S': return YYEncodingTypeUInt16 | qualifier;
            case 'i': return YYEncodingTypeInt32 | qualifier;
            case 'I': return YYEncodingTypeUInt32 | qualifier;
            case 'l': return YYEncodingTypeInt32 | qualifier;
            case 'L': return YYEncodingTypeUInt32 | qualifier;
            case 'q': return YYEncodingTypeInt64 | qualifier;
            case 'Q': return YYEncodingTypeUInt64 | qualifier;
            case 'f': return YYEncodingTypeFloat | qualifier;
            case 'd': return YYEncodingTypeDouble | qualifier;
            case 'D': return YYEncodingTypeLongDouble | qualifier;
            case '#': return YYEncodingTypeClass | qualifier;
            case ':': return YYEncodingTypeSEL | qualifier;
            case '*': return YYEncodingTypeCString | qualifier;
            case '^': return YYEncodingTypePointer | qualifier;
            case '[': return YYEncodingTypeCArray | qualifier;
            case '(': return YYEncodingTypeUnion | qualifier;
            case '{': return YYEncodingTypeStruct | qualifier;
            case '@': {
                if (len == 2 && *(type + 1) == '?')
                    return YYEncodingTypeBlock | qualifier;
                else
                    return YYEncodingTypeObject | qualifier;
            }
            default: return YYEncodingTypeUnknown | qualifier;
        }
    }
